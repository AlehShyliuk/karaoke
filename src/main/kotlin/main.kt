import javazoom.jl.player.Player
import kotlinx.coroutines.*
import java.io.InputStream
import java.net.URI
import java.net.URLEncoder
import java.net.http.HttpClient
import java.net.http.HttpRequest
import java.net.http.HttpResponse

fun main() = runBlocking {
    val generateSoundUrl =
        "https://nextup.com/ivona/php/nextup-polly/CreateSpeech/CreateSpeechGet3.php?voice=Maxim&language=ru-RU&text="
    val textLines = arrayOf(
        "А, мой, мальчик, едет на девятке",
        "По автостраде, вдоль ночных дорог",
        "Я, круужилась, с ним на танцплощадке",
        "А ты и дальше, будешь одинок"
    )
    val words = ArrayList<String>()
    val soundArr = ArrayList<InputStream>()

    textLines.forEach { line ->
        words.addAll(line.split(" "))
    }

    for (line in textLines) {
        val client = HttpClient.newBuilder().build()
        val generateSoundRequest = HttpRequest.newBuilder()
            .uri(URI.create(generateSoundUrl + URLEncoder.encode(line, "UTF-8")))
            .build()

        val soundUrl = client.send(generateSoundRequest, HttpResponse.BodyHandlers.ofString()).body()

        val playSoundRequest = HttpRequest.newBuilder()
            .uri(URI.create(soundUrl))
            .build()

        soundArr.add(client.send(playSoundRequest, HttpResponse.BodyHandlers.ofInputStream()).body())
    }

    playAndWrite(soundArr, words)
    printPhoto()
}

suspend fun playAndWrite(soundArr: ArrayList<InputStream>, words: ArrayList<String>) = withContext(Dispatchers.IO) {
    listOf(
        launch {
            write(words)
        },
        launch {
            var playMP3: Player

            soundArr.forEachIndexed { index, element ->
                playMP3 = Player(element)
                playMP3.play()

                delay(400L)
            }
        }
    ).joinAll()
}

suspend fun write(words: ArrayList<String>) {
    var curWord = 0
    print(words[curWord++] + " ")
    delay(400)
    print(words[curWord++] + " ")
    delay(400)
    print(words[curWord++] + " ")
    delay(800)
    print(words[curWord++] + " ")
    delay(450)
    print(words[curWord++] + " ")
    delay(200)
    println(words[curWord++])
    delay(700)

    print(words[curWord++] + " ")
    delay(500)
    print(words[curWord++] + " ")
    delay(1000)
    print(words[curWord++] + " ")
    delay(600)
    print(words[curWord++] + " ")
    delay(600)
    println(words[curWord++])
    delay(700)

    print(words[curWord++] + " ")
    delay(500)
    print(words[curWord++] + " ")
    delay(900)
    print(words[curWord++] + " ")
    delay(600)
    print(words[curWord++] + " ")
    delay(600)
    print(words[curWord++] + " ")
    delay(600)
    println(words[curWord++])
    delay(700)

    print(words[curWord++] + " ")
    delay(500)
    print(words[curWord++] + " ")
    delay(400)
    print(words[curWord++] + " ")
    delay(400)
    print(words[curWord++] + " ")
    delay(600)
    print(words[curWord++] + " ")
    delay(600)
    println(words[curWord])
}

suspend fun printPhoto() {
    val photo = arrayOf(
        "+++++++++++++==+++++++++++++++++++++================+======+=+===+============++++++=++++++++++++++++====++=============",
        "+++++++++++++++++++=+++++++++==========================%%%%%%===========================================================",
        "+++++++++++++++++++++=++++++====================%@@###############@%====================================================",
        "++++++++++++++===+======+++==================@################@#######%=================================================",
        "++++++++++==+===+++++=+++=+===============%@############################@%==============================================",
        "+++++++++=======++++=+++++==============%@################################@%============================================",
        "+++++=+======++++====++==+=============@########################@@##########%%==========================================",
        "++++=++=+====+======+++==============%####################%=======%@@@#######@%=========================================",
        "+++++++==++=++===+++====+===========%###################%=+++++++++==%@########%========================================",
        "+++++++==+++=======================%##################@%+******++++++=%@########%=======================================",
        "++++++++++++=+====================%#################@%=+*********++++++%#########@%=====================================",
        "++++++++++++=====================%@###############@%==+***********+++++=@##########%====================================",
        "++++++++++=======================@###############@==++*************++++=%@##########%===================================",
        "+++++++++=======================@###############@==+*******:******+==%%==%###########@%=================================",
        "++++++++++++======+============@@##############@@%=++********+%@@%========%###########@%================================",
        "+++++++++++==================%%%###############@%=====++****+==%@#####%++=%############@%===============================",
        "+++++++++++=================%%%%##############@%####@%=++**+====+=%%%=+++=%@###########@%===============================",
        "+++++++++++===============%%%%%###############%%@%=%%==+++*+==++++*****++=%@############@%==============================",
        "++++++++++===============%@@@#################@===+++++*++*+==++*******++=%@############@%==============================",
        "+++++++++==============%%%####################@=+++******+++=%=+******++=%@##############@%=============================",
        "+++++++++=============%%@######################%++******++++==%+******+==%@##############@%=============================",
        "+++++++++===========%%@#########################=+*******+++=%=+*****++=%%@###############@%============================",
        "+++++++++++========%=%###########################=+*******+**+++*****++=%%@################@@%==========================",
        "+++++++++++========%=@###########################@=+******++===+++**+++==%##################@@@%========================",
        "++++++++++++=======%%@#############################=+***+=%%==%@%%++++==%#####################@@@%======================",
        "+++++++++++=========%###############################%+***+========+++==%#######################@@@@@@@%=================",
        "+++++++++=========%###################################=+*****++*++++=%%@#########################@@@@@@@%===============",
        "+++++++++=======@#######################################=********+====%%@#########################@@@@@@@@%=============",
        "++++++++========%#######################################@%=+++++=======%@##########################@@@@@@@%=============",
        "+++++++========%%######################################@@%==============@###########################@@@@@@%=============",
        "++++++========%@#####################################@@@%%==============@#############################@@@@@%============",
        "+++++++======%@#####################################@%%%%==============%###############################@@@@@@@@%========",
        "+++++++=====%@######################################%%=%%====+++++++===%################################@@@@@@@@%=======",
        "++++++===%%#########################################%======++++++++++++%################################@@@@@@@%@%======",
        "++++++==%#@#########################################%====%==++++++++++=@#################################@@@@@@%@%======",
        "+++++===@##########################################@%=================+##################################@@@@@@@@%======",
        "+++++==%###########################################@====++++++++++++==%##################################@@@@@@@@@@@%===",
        "+++++=%############################################@==++++++++++++++++####################################@@@@@@@@@@%===",
        "++++==#############################################@=++++++*****+++++%#####################################@@@@@@@@@%==="
    )
    photo.forEach {
        println(it)
        delay(75)
    }
}
